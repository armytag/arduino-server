<!DOCTYPE html>
<html>
    <head>
    </head>
    <body>
<pre>
<font color="#95a5a6">&#47;* </font>
<font color="#95a5a6"> * &nbsp;Code for running a more sophisticated webserver on an Arduino Uno</font>
<font color="#95a5a6"> * &nbsp;</font>
<font color="#95a5a6"> * &nbsp;created &nbsp;11 Sep 2019 </font>
<font color="#95a5a6"> * &nbsp;modified 13 Nov 2019</font>
<font color="#95a5a6"> * &nbsp;by Tristan Armitage</font>
<font color="#95a5a6"> *&#47;</font>

<font color="#5e6d03">#include</font> <font color="#434f54">&lt;</font><b><font color="#d35400">SPI</font></b><font color="#434f54">.</font><font color="#000000">h</font><font color="#434f54">&gt;</font>
<font color="#5e6d03">#include</font> <font color="#434f54">&lt;</font><b><font color="#d35400">SD</font></b><font color="#434f54">.</font><font color="#000000">h</font><font color="#434f54">&gt;</font>
<font color="#5e6d03">#include</font> <font color="#434f54">&lt;</font><b><font color="#d35400">Ethernet</font></b><font color="#434f54">.</font><font color="#000000">h</font><font color="#434f54">&gt;</font>

<font color="#00979c">const</font> <font color="#00979c">boolean</font> <font color="#000000">DISPLAYING</font> <font color="#434f54">=</font> <font color="#00979c">true</font><font color="#000000">;</font>
<font color="#00979c">const</font> <font color="#00979c">boolean</font> <font color="#000000">DEBUGGING</font> &nbsp;<font color="#434f54">=</font> <font color="#00979c">false</font><font color="#000000">;</font>
<font color="#00979c">const</font> <font color="#00979c">short</font> <font color="#000000">MAX_METHOD_LENGTH</font> <font color="#434f54">=</font> <font color="#000000">10</font><font color="#000000">;</font>
<font color="#00979c">const</font> <font color="#00979c">short</font> <font color="#000000">MAX_URI_LENGTH</font> <font color="#434f54">=</font> <font color="#000000">40</font><font color="#000000">;</font>
<font color="#00979c">const</font> <font color="#00979c">short</font> <font color="#000000">MAX_HEAD_BUF_LENGTH</font> <font color="#434f54">=</font> <font color="#000000">100</font><font color="#000000">;</font>
<font color="#00979c">short</font> <font color="#000000">MethodLen</font><font color="#000000">;</font>
<font color="#00979c">short</font> <font color="#000000">UriLen</font><font color="#000000">;</font>
<font color="#00979c">short</font> <font color="#000000">HeadBufLen</font><font color="#000000">;</font>

<font color="#00979c">char</font> <font color="#000000">RequestMethod</font><font color="#000000">[</font><font color="#000000">MAX_METHOD_LENGTH</font><font color="#000000">]</font><font color="#000000">;</font>
<font color="#00979c">char</font> <font color="#000000">RequestUri</font><font color="#000000">[</font><font color="#000000">MAX_URI_LENGTH</font><font color="#000000">]</font><font color="#000000">;</font>
<font color="#00979c">char</font> <font color="#000000">HeaderBuffer</font><font color="#000000">[</font><font color="#000000">MAX_HEAD_BUF_LENGTH</font><font color="#000000">]</font><font color="#000000">;</font>

<font color="#95a5a6">&#47;* This is a base64 encoding of {username:password}, typical of simple HTTP authorization *&#47;</font> 
<font color="#00979c">char</font> <font color="#000000">Authorization</font><font color="#000000">[</font><font color="#000000">]</font> <font color="#434f54">=</font> <font color="#005c5f">&#34;YXJteXRhZzpwYXNzd29yZA==&#34;</font><font color="#000000">;</font>
<font color="#00979c">boolean</font> <font color="#000000">Authorized</font><font color="#000000">;</font>

<font color="#00979c">byte</font> <font color="#000000">mac</font><font color="#000000">[</font><font color="#000000">]</font> &nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">=</font> <font color="#000000">{</font> <font color="#000000">0xDE</font><font color="#434f54">,</font> <font color="#000000">0xAD</font><font color="#434f54">,</font> <font color="#000000">0xBE</font><font color="#434f54">,</font> <font color="#000000">0xEF</font><font color="#434f54">,</font> <font color="#000000">0xFE</font><font color="#434f54">,</font> <font color="#000000">0xED</font> <font color="#000000">}</font><font color="#000000">;</font>
<font color="#00979c">byte</font> <font color="#000000">subnet</font><font color="#000000">[</font><font color="#000000">]</font> &nbsp;<font color="#434f54">=</font> <font color="#000000">{</font> <font color="#000000">255</font><font color="#434f54">,</font> <font color="#000000">255</font><font color="#434f54">,</font> <font color="#000000">255</font><font color="#434f54">,</font> <font color="#000000">0</font> <font color="#000000">}</font><font color="#000000">;</font>
<font color="#00979c">byte</font> <font color="#000000">gateway</font><font color="#000000">[</font><font color="#000000">]</font> <font color="#434f54">=</font> <font color="#000000">{</font> <font color="#000000">192</font><font color="#434f54">,</font> <font color="#000000">168</font><font color="#434f54">,</font> <font color="#000000">0</font><font color="#434f54">,</font> <font color="#000000">1</font> <font color="#000000">}</font><font color="#000000">;</font>
<b><font color="#d35400">IPAddress</font></b> <font color="#000000">ip</font><font color="#000000">(</font><font color="#000000">192</font><font color="#434f54">,</font> <font color="#000000">168</font><font color="#434f54">,</font> <font color="#000000">0</font><font color="#434f54">,</font> <font color="#000000">10</font><font color="#000000">)</font><font color="#000000">;</font>
<b><font color="#d35400">EthernetServer</font></b> <font color="#000000">server</font><font color="#000000">(</font><font color="#000000">80</font><font color="#000000">)</font><font color="#000000">;</font>


<font color="#95a5a6">&#47;* Normal setup function. Calls the specific setup functions implemented below *&#47;</font>
<font color="#00979c">void</font> 
<font color="#5e6d03">setup</font><font color="#000000">(</font><font color="#000000">)</font> <font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font><font color="#000000">(</font><font color="#000000">DISPLAYING</font><font color="#434f54">||</font><font color="#000000">DEBUGGING</font><font color="#000000">)</font><font color="#000000">{</font> <b><font color="#d35400">Serial</font></b><font color="#434f54">.</font><font color="#d35400">begin</font><font color="#000000">(</font><font color="#000000">9600</font><font color="#000000">)</font><font color="#000000">;</font> <font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">setupEthernet</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">setupSD</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">setupServer</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">MethodLen</font> <font color="#434f54">=</font> <font color="#000000">MAX_METHOD_LENGTH</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">UriLen</font> <font color="#434f54">=</font> <font color="#000000">MAX_URI_LENGTH</font><font color="#000000">;</font>
<font color="#000000">}</font>

<font color="#95a5a6">&#47;* Normal loop function.</font>
<font color="#95a5a6"> * NOTE: You can pass the client to other functions (not pointer notation needed). *&#47;</font>
<font color="#00979c">void</font> 
<font color="#5e6d03">loop</font><font color="#000000">(</font><font color="#000000">)</font> <font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; Reset the request strings</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">clearRequestMethod</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">clearRequestUri</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">Authorized</font> <font color="#434f54">=</font> <font color="#00979c">false</font><font color="#000000">;</font>

 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; Check for an available client</font>
 &nbsp;&nbsp;&nbsp;<b><font color="#d35400">EthernetClient</font></b> <font color="#000000">client</font> <font color="#434f54">=</font> <font color="#000000">server</font><font color="#434f54">.</font><font color="#d35400">available</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font> <font color="#000000">(</font><font color="#000000">client</font><font color="#000000">)</font> <font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font> <font color="#000000">(</font><font color="#000000">DEBUGGING</font><font color="#000000">)</font> <font color="#000000">{</font><b><font color="#d35400">Serial</font></b><font color="#434f54">.</font><font color="#d35400">println</font><font color="#000000">(</font><font color="#000000">F</font><font color="#000000">(</font><font color="#005c5f">&#34;---New Client---&#34;</font><font color="#000000">)</font><font color="#000000">)</font><font color="#000000">;</font><font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">boolean</font> <font color="#000000">currentLineIsBlank</font> <font color="#434f54">=</font> <font color="#00979c">true</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">readRequestLine</font><font color="#000000">(</font><font color="#000000">client</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font> <font color="#000000">(</font><font color="#000000">DISPLAYING</font><font color="#434f54">||</font><font color="#000000">DEBUGGING</font><font color="#000000">)</font> <font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b><font color="#d35400">Serial</font></b><font color="#434f54">.</font><font color="#d35400">print</font><font color="#000000">(</font><font color="#000000">RequestMethod</font><font color="#000000">)</font><font color="#000000">;</font> <b><font color="#d35400">Serial</font></b><font color="#434f54">.</font><font color="#d35400">print</font><font color="#000000">(</font><font color="#005c5f">&#34; &#34;</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b><font color="#d35400">Serial</font></b><font color="#434f54">.</font><font color="#d35400">print</font><font color="#000000">(</font><font color="#000000">RequestUri</font><font color="#000000">)</font><font color="#000000">;</font> <b><font color="#d35400">Serial</font></b><font color="#434f54">.</font><font color="#d35400">print</font><font color="#000000">(</font><font color="#005c5f">&#34; &#34;</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font> <font color="#000000">(</font><font color="#000000">DEBUGGING</font><font color="#000000">)</font> <font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b><font color="#d35400">Serial</font></b><font color="#434f54">.</font><font color="#d35400">print</font><font color="#000000">(</font><font color="#000000">parseContentType</font><font color="#000000">(</font><font color="#000000">RequestUri</font><font color="#000000">)</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">while</font> <font color="#000000">(</font><font color="#000000">client</font><font color="#434f54">.</font><font color="#d35400">connected</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">)</font> <font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font> <font color="#000000">(</font><font color="#000000">client</font><font color="#434f54">.</font><font color="#d35400">available</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">)</font> <font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">char</font> <font color="#000000">c</font> <font color="#434f54">=</font> <font color="#000000">client</font><font color="#434f54">.</font><font color="#d35400">read</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font> <font color="#000000">(</font><font color="#000000">DEBUGGING</font><font color="#000000">)</font> <font color="#000000">{</font><b><font color="#d35400">Serial</font></b><font color="#434f54">.</font><font color="#d35400">write</font><font color="#000000">(</font><font color="#000000">c</font><font color="#000000">)</font><font color="#000000">;</font><font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font> <font color="#000000">(</font><font color="#000000">c</font><font color="#434f54">==</font><font color="#00979c">&#39;\n&#39;</font><font color="#000000">)</font> <font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font> <font color="#000000">(</font><font color="#000000">currentLineIsBlank</font><font color="#000000">)</font> <font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">handleRequest</font><font color="#000000">(</font><font color="#000000">client</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">break</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font> <font color="#5e6d03">else</font> <font color="#000000">{</font> <font color="#434f54">&#47;&#47;Process header line</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font> <font color="#000000">(</font><font color="#000000">DEBUGGING</font><font color="#000000">)</font> <font color="#000000">{</font><b><font color="#d35400">Serial</font></b><font color="#434f54">.</font><font color="#d35400">println</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font><font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">parseHeaderLine</font><font color="#000000">(</font><font color="#000000">client</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">currentLineIsBlank</font> <font color="#434f54">=</font> <font color="#00979c">true</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font> <font color="#434f54">&#47;&#47;end if(c==&#39;\n&#39;)</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">else</font> <font color="#5e6d03">if</font> <font color="#000000">(</font><font color="#000000">c</font><font color="#434f54">!=</font><font color="#00979c">&#39;\r&#39;</font><font color="#000000">)</font> <font color="#000000">{</font> 
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font> <font color="#000000">(</font><font color="#000000">HeadBufLen</font><font color="#434f54">&lt;</font><font color="#000000">MAX_HEAD_BUF_LENGTH</font><font color="#000000">)</font> <font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">HeaderBuffer</font><font color="#000000">[</font><font color="#000000">HeadBufLen</font><font color="#000000">]</font> <font color="#434f54">=</font> <font color="#000000">c</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">HeadBufLen</font><font color="#434f54">++</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">currentLineIsBlank</font><font color="#434f54">=</font><font color="#00979c">false</font><font color="#000000">;</font> 
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font><font color="#434f54">&#47;&#47;end if(client.available())</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#d35400">delay</font><font color="#000000">(</font><font color="#000000">1</font><font color="#000000">)</font><font color="#000000">;</font> <font color="#434f54">&#47;&#47; Give the web browser time to receive the data</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">client</font><font color="#434f54">.</font><font color="#d35400">stop</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font> <font color="#434f54">&#47;&#47; Close the connection &nbsp;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font> <font color="#000000">(</font><font color="#000000">DEBUGGING</font><font color="#000000">)</font> <font color="#000000">{</font><b><font color="#d35400">Serial</font></b><font color="#434f54">.</font><font color="#d35400">println</font><font color="#000000">(</font><font color="#000000">F</font><font color="#000000">(</font><font color="#005c5f">&#34;---Client Closed---&#34;</font><font color="#000000">)</font><font color="#000000">)</font><font color="#000000">;</font><font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font> <font color="#000000">(</font><font color="#000000">DEBUGGING</font><font color="#434f54">||</font><font color="#000000">DISPLAYING</font><font color="#000000">)</font> <font color="#000000">{</font><b><font color="#d35400">Serial</font></b><font color="#434f54">.</font><font color="#d35400">println</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font><font color="#000000">}</font> &nbsp;
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font><font color="#434f54">&#47;&#47;end if(client)</font>
<font color="#000000">}</font>

<font color="#95a5a6">&#47;* Functions for setting up the hardware peripherals, i.e. Ethernet and SD *&#47;</font>
<font color="#00979c">void</font> 
<font color="#000000">setupEthernet</font><font color="#000000">(</font><font color="#000000">)</font> <font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;<b><font color="#d35400">Ethernet</font></b><font color="#434f54">.</font><font color="#d35400">begin</font><font color="#000000">(</font><font color="#000000">mac</font><font color="#434f54">,</font> <font color="#000000">ip</font><font color="#434f54">,</font> <font color="#000000">gateway</font><font color="#434f54">,</font> <font color="#000000">subnet</font><font color="#000000">)</font><font color="#000000">;</font>

 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font> <font color="#000000">(</font><b><font color="#d35400">Ethernet</font></b><font color="#434f54">.</font><font color="#d35400">hardwareStatus</font><font color="#000000">(</font><font color="#000000">)</font> <font color="#434f54">==</font> <font color="#00979c">EthernetNoHardware</font><font color="#000000">)</font> <font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font> <font color="#000000">(</font><font color="#000000">DEBUGGING</font><font color="#000000">)</font> <font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b><font color="#d35400">Serial</font></b><font color="#434f54">.</font><font color="#d35400">println</font><font color="#000000">(</font><font color="#000000">F</font><font color="#000000">(</font><font color="#005c5f">&#34;No ethernet shield&#34;</font><font color="#000000">)</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font> <font color="#434f54">&#47;&#47;Send status if in debug mode</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">while</font> <font color="#000000">(</font><font color="#00979c">true</font><font color="#000000">)</font> <font color="#000000">{</font> <font color="#d35400">delay</font><font color="#000000">(</font><font color="#000000">1</font><font color="#000000">)</font><font color="#000000">;</font> <font color="#000000">}</font> <font color="#434f54">&#47;&#47;lock in an infinite loop</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font> <font color="#000000">(</font><b><font color="#d35400">Ethernet</font></b><font color="#434f54">.</font><font color="#d35400">linkStatus</font><font color="#000000">(</font><font color="#000000">)</font> <font color="#434f54">==</font> <font color="#00979c">LinkOFF</font><font color="#000000">)</font> <font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font> <font color="#000000">(</font><font color="#000000">DEBUGGING</font><font color="#000000">)</font> <font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b><font color="#d35400">Serial</font></b><font color="#434f54">.</font><font color="#d35400">println</font><font color="#000000">(</font><font color="#000000">F</font><font color="#000000">(</font><font color="#005c5f">&#34;No ethernet cable connected&#34;</font><font color="#000000">)</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
<font color="#000000">}</font>
<font color="#00979c">void</font> 
<font color="#000000">setupSD</font><font color="#000000">(</font><font color="#000000">)</font> <font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font> <font color="#000000">(</font><font color="#434f54">!</font><b><font color="#d35400">SD</font></b><font color="#434f54">.</font><font color="#d35400">begin</font><font color="#000000">(</font><font color="#000000">4</font><font color="#000000">)</font><font color="#000000">)</font> <font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font> <font color="#000000">(</font><font color="#000000">DEBUGGING</font><font color="#000000">)</font> <font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b><font color="#d35400">Serial</font></b><font color="#434f54">.</font><font color="#d35400">println</font><font color="#000000">(</font><font color="#000000">F</font><font color="#000000">(</font><font color="#005c5f">&#34;Could not initialize SD card&#34;</font><font color="#000000">)</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">while</font> <font color="#000000">(</font><font color="#00979c">true</font><font color="#000000">)</font> <font color="#000000">{</font> <font color="#d35400">delay</font><font color="#000000">(</font><font color="#000000">1</font><font color="#000000">)</font><font color="#000000">;</font> <font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
<font color="#000000">}</font>
<font color="#00979c">void</font> 
<font color="#000000">setupServer</font><font color="#000000">(</font><font color="#000000">)</font> <font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">server</font><font color="#434f54">.</font><font color="#d35400">begin</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font> <font color="#000000">(</font><font color="#000000">DISPLAYING</font><font color="#434f54">||</font><font color="#000000">DEBUGGING</font><font color="#000000">)</font> <font color="#000000">{</font> 
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b><font color="#d35400">Serial</font></b><font color="#434f54">.</font><font color="#d35400">println</font><font color="#000000">(</font><font color="#000000">F</font><font color="#000000">(</font><font color="#005c5f">&#34;Arduino Server started&#34;</font><font color="#000000">)</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b><font color="#d35400">Serial</font></b><font color="#434f54">.</font><font color="#d35400">print</font> &nbsp;<font color="#000000">(</font><font color="#000000">F</font><font color="#000000">(</font><font color="#005c5f">&#34;Server is at &#34;</font><font color="#000000">)</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b><font color="#d35400">Serial</font></b><font color="#434f54">.</font><font color="#d35400">println</font><font color="#000000">(</font><b><font color="#d35400">Ethernet</font></b><font color="#434f54">.</font><font color="#d35400">localIP</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
<font color="#000000">}</font>
<font color="#95a5a6">&#47;* Finish setup functions *&#47;</font> 

<font color="#00979c">void</font>
<font color="#000000">clearRequestMethod</font><font color="#000000">(</font><font color="#000000">)</font> <font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">while</font> <font color="#000000">(</font><font color="#000000">MethodLen</font><font color="#434f54">&gt;</font><font color="#000000">0</font><font color="#000000">)</font> <font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">MethodLen</font><font color="#434f54">--</font><font color="#000000">;</font> <font color="#000000">RequestMethod</font><font color="#000000">[</font><font color="#000000">MethodLen</font><font color="#000000">]</font><font color="#434f54">=</font><font color="#000000">0</font><font color="#000000">;</font>
 &nbsp;&nbsp;<font color="#000000">}</font>
<font color="#000000">}</font>
<font color="#00979c">void</font>
<font color="#000000">clearRequestUri</font><font color="#000000">(</font><font color="#000000">)</font> <font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">while</font> <font color="#000000">(</font><font color="#000000">UriLen</font><font color="#434f54">&gt;</font><font color="#000000">0</font><font color="#000000">)</font> <font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">UriLen</font><font color="#434f54">--</font><font color="#000000">;</font> <font color="#000000">RequestUri</font><font color="#000000">[</font><font color="#000000">UriLen</font><font color="#000000">]</font><font color="#434f54">=</font><font color="#000000">0</font><font color="#000000">;</font>
 &nbsp;&nbsp;<font color="#000000">}</font>
<font color="#000000">}</font>

<font color="#00979c">void</font>
<font color="#000000">readRequestLine</font><font color="#000000">(</font><b><font color="#d35400">EthernetClient</font></b> <font color="#000000">client</font><font color="#000000">)</font> <font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">char</font> <font color="#000000">c</font> <font color="#434f54">=</font> <font color="#000000">client</font><font color="#434f54">.</font><font color="#d35400">read</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#95a5a6">&#47;* Read the HTTP request, which should be the first line coming from the client</font>
<font color="#95a5a6"> &nbsp;&nbsp;&nbsp;* NOTE: A typical URI request should work fine, including folders and the initial &#39;&#47;&#39; character *&#47;</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">while</font> <font color="#000000">(</font><font color="#000000">c</font><font color="#434f54">!=</font><font color="#00979c">&#39; &#39;</font> <font color="#434f54">&amp;&amp;</font> <font color="#000000">client</font><font color="#434f54">.</font><font color="#d35400">connected</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">)</font> <font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">RequestMethod</font><font color="#000000">[</font><font color="#000000">MethodLen</font><font color="#000000">]</font><font color="#434f54">=</font><font color="#000000">c</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">MethodLen</font><font color="#434f54">++</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">c</font><font color="#434f54">=</font><font color="#000000">client</font><font color="#434f54">.</font><font color="#d35400">read</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">c</font> <font color="#434f54">=</font> <font color="#000000">client</font><font color="#434f54">.</font><font color="#d35400">read</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">while</font> <font color="#000000">(</font><font color="#000000">c</font><font color="#434f54">!=</font><font color="#00979c">&#39; &#39;</font> <font color="#434f54">&amp;&amp;</font> <font color="#000000">client</font><font color="#434f54">.</font><font color="#d35400">connected</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">)</font> <font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">RequestUri</font><font color="#000000">[</font><font color="#000000">UriLen</font><font color="#000000">]</font><font color="#434f54">=</font><font color="#000000">c</font><font color="#000000">;</font> 
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">UriLen</font><font color="#434f54">++</font><font color="#000000">;</font> 
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">c</font><font color="#434f54">=</font><font color="#000000">client</font><font color="#434f54">.</font><font color="#d35400">read</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font> <font color="#000000">(</font><font color="#000000">RequestUri</font><font color="#000000">[</font><font color="#000000">UriLen</font><font color="#434f54">-</font><font color="#000000">1</font><font color="#000000">]</font><font color="#434f54">==</font><font color="#00979c">&#39;&#47;&#39;</font> <font color="#434f54">&amp;&amp;</font> <font color="#000000">client</font><font color="#434f54">.</font><font color="#d35400">connected</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">)</font> <font color="#000000">{</font> 
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">RequestUri</font><font color="#000000">[</font><font color="#000000">UriLen</font><font color="#000000">]</font> <font color="#434f54">=</font> <font color="#00979c">&#39;i&#39;</font><font color="#000000">;</font> <font color="#000000">UriLen</font><font color="#434f54">++</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">RequestUri</font><font color="#000000">[</font><font color="#000000">UriLen</font><font color="#000000">]</font> <font color="#434f54">=</font> <font color="#00979c">&#39;n&#39;</font><font color="#000000">;</font> <font color="#000000">UriLen</font><font color="#434f54">++</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">RequestUri</font><font color="#000000">[</font><font color="#000000">UriLen</font><font color="#000000">]</font> <font color="#434f54">=</font> <font color="#00979c">&#39;d&#39;</font><font color="#000000">;</font> <font color="#000000">UriLen</font><font color="#434f54">++</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">RequestUri</font><font color="#000000">[</font><font color="#000000">UriLen</font><font color="#000000">]</font> <font color="#434f54">=</font> <font color="#00979c">&#39;e&#39;</font><font color="#000000">;</font> <font color="#000000">UriLen</font><font color="#434f54">++</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">RequestUri</font><font color="#000000">[</font><font color="#000000">UriLen</font><font color="#000000">]</font> <font color="#434f54">=</font> <font color="#00979c">&#39;x&#39;</font><font color="#000000">;</font> <font color="#000000">UriLen</font><font color="#434f54">++</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">RequestUri</font><font color="#000000">[</font><font color="#000000">UriLen</font><font color="#000000">]</font> <font color="#434f54">=</font> <font color="#00979c">&#39;.&#39;</font><font color="#000000">;</font> <font color="#000000">UriLen</font><font color="#434f54">++</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">RequestUri</font><font color="#000000">[</font><font color="#000000">UriLen</font><font color="#000000">]</font> <font color="#434f54">=</font> <font color="#00979c">&#39;h&#39;</font><font color="#000000">;</font> <font color="#000000">UriLen</font><font color="#434f54">++</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">RequestUri</font><font color="#000000">[</font><font color="#000000">UriLen</font><font color="#000000">]</font> <font color="#434f54">=</font> <font color="#00979c">&#39;t&#39;</font><font color="#000000">;</font> <font color="#000000">UriLen</font><font color="#434f54">++</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">RequestUri</font><font color="#000000">[</font><font color="#000000">UriLen</font><font color="#000000">]</font> <font color="#434f54">=</font> <font color="#00979c">&#39;m&#39;</font><font color="#000000">;</font> <font color="#000000">UriLen</font><font color="#434f54">++</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font> 
<font color="#000000">}</font>
<font color="#00979c">void</font>
<font color="#000000">handleRequest</font><font color="#000000">(</font><b><font color="#d35400">EthernetClient</font></b> <font color="#000000">client</font><font color="#000000">)</font> <font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font> <font color="#000000">(</font><font color="#d35400">strcmp</font><font color="#000000">(</font><font color="#000000">RequestMethod</font><font color="#434f54">,</font><font color="#005c5f">&#34;GET&#34;</font><font color="#000000">)</font><font color="#434f54">==</font><font color="#000000">0</font><font color="#000000">)</font> <font color="#000000">{</font><font color="#000000">processGetRequest</font><font color="#000000">(</font><font color="#000000">client</font><font color="#434f54">,</font><font color="#000000">RequestUri</font><font color="#000000">)</font><font color="#000000">;</font><font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">else</font> <font color="#5e6d03">if</font> <font color="#000000">(</font><font color="#d35400">strcmp</font><font color="#000000">(</font><font color="#000000">RequestMethod</font><font color="#434f54">,</font><font color="#005c5f">&#34;PUT&#34;</font><font color="#000000">)</font><font color="#434f54">==</font><font color="#000000">0</font><font color="#000000">)</font> <font color="#000000">{</font><font color="#000000">processPutRequest</font><font color="#000000">(</font><font color="#000000">client</font><font color="#434f54">,</font><font color="#000000">RequestUri</font><font color="#000000">)</font><font color="#000000">;</font><font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">else</font> <font color="#5e6d03">if</font> <font color="#000000">(</font><font color="#d35400">strcmp</font><font color="#000000">(</font><font color="#000000">RequestMethod</font><font color="#434f54">,</font><font color="#005c5f">&#34;HEAD&#34;</font><font color="#000000">)</font><font color="#434f54">==</font><font color="#000000">0</font><font color="#000000">)</font> <font color="#000000">{</font><font color="#000000">processHeadRequest</font><font color="#000000">(</font><font color="#000000">client</font><font color="#434f54">,</font><font color="#000000">RequestUri</font><font color="#000000">)</font><font color="#000000">;</font><font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">else</font> <font color="#5e6d03">if</font> <font color="#000000">(</font><font color="#d35400">strcmp</font><font color="#000000">(</font><font color="#000000">RequestMethod</font><font color="#434f54">,</font><font color="#005c5f">&#34;POST&#34;</font><font color="#000000">)</font><font color="#434f54">==</font><font color="#000000">0</font><font color="#000000">)</font> <font color="#000000">{</font><font color="#000000">processPostRequest</font><font color="#000000">(</font><font color="#000000">client</font><font color="#434f54">,</font><font color="#000000">RequestUri</font><font color="#000000">)</font><font color="#000000">;</font><font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">else</font> <font color="#000000">{</font><font color="#000000">client</font><font color="#434f54">.</font><font color="#d35400">println</font><font color="#000000">(</font><font color="#000000">F</font><font color="#000000">(</font><font color="#005c5f">&#34;HTTP&#47;1.1 400 Bad Request\n&#34;</font><font color="#000000">)</font><font color="#000000">)</font><font color="#000000">;</font><font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">return</font><font color="#000000">;</font>
<font color="#000000">}</font>
<font color="#00979c">void</font>
<font color="#000000">parseHeaderLine</font><font color="#000000">(</font><b><font color="#d35400">EthernetClient</font></b> <font color="#000000">client</font><font color="#000000">)</font> <font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">char</font> <font color="#000000">headerField</font><font color="#000000">[</font><font color="#000000">40</font><font color="#000000">]</font> <font color="#434f54">=</font> <font color="#005c5f">&#34;&#34;</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">short</font> <font color="#000000">hfLen</font><font color="#434f54">=</font><font color="#000000">0</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">while</font><font color="#000000">(</font><font color="#000000">(</font><font color="#000000">HeaderBuffer</font><font color="#000000">[</font><font color="#000000">hfLen</font><font color="#000000">]</font><font color="#434f54">!=</font><font color="#00979c">&#39;:&#39;</font><font color="#000000">)</font><font color="#434f54">&amp;&amp;</font><font color="#000000">(</font><font color="#000000">hfLen</font><font color="#434f54">&lt;</font><font color="#000000">40</font><font color="#000000">)</font><font color="#434f54">&amp;&amp;</font><font color="#000000">(</font><font color="#000000">hfLen</font><font color="#434f54">&lt;</font><font color="#000000">HeadBufLen</font><font color="#000000">)</font><font color="#000000">)</font> <font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">headerField</font><font color="#000000">[</font><font color="#000000">hfLen</font><font color="#000000">]</font> <font color="#434f54">=</font> <font color="#000000">HeaderBuffer</font><font color="#000000">[</font><font color="#000000">hfLen</font><font color="#000000">]</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">hfLen</font><font color="#434f54">++</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font><font color="#000000">(</font><font color="#d35400">strcmp</font><font color="#000000">(</font><font color="#000000">headerField</font><font color="#434f54">,</font><font color="#005c5f">&#34;Authorization&#34;</font><font color="#000000">)</font><font color="#434f54">==</font><font color="#000000">0</font><font color="#000000">)</font><font color="#000000">{</font> 
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font><font color="#000000">(</font><font color="#d35400">strcmp</font><font color="#000000">(</font><font color="#434f54">&amp;</font><font color="#000000">HeaderBuffer</font><font color="#000000">[</font><font color="#000000">hfLen</font><font color="#434f54">+</font><font color="#000000">8</font><font color="#000000">]</font><font color="#434f54">,</font><font color="#000000">Authorization</font><font color="#000000">)</font><font color="#434f54">==</font><font color="#000000">0</font><font color="#000000">)</font><font color="#000000">{</font> <font color="#000000">Authorized</font><font color="#434f54">=</font><font color="#00979c">true</font><font color="#000000">;</font> <font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Clear the char buffer</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">while</font><font color="#000000">(</font><font color="#000000">HeadBufLen</font> <font color="#434f54">&gt;</font> <font color="#000000">0</font><font color="#000000">)</font> <font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">HeadBufLen</font><font color="#434f54">--</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">HeaderBuffer</font><font color="#000000">[</font><font color="#000000">HeadBufLen</font><font color="#000000">]</font> <font color="#434f54">=</font> <font color="#000000">0</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
<font color="#000000">}</font>

<font color="#95a5a6">&#47;* Functions for handling particular HTTP requests *&#47;</font>
<font color="#00979c">void</font> 
<font color="#000000">processHeadRequest</font><font color="#000000">(</font><b><font color="#d35400">EthernetClient</font></b> <font color="#000000">client</font><font color="#434f54">,</font> <font color="#00979c">char</font><font color="#434f54">*</font> <font color="#000000">uri</font><font color="#000000">)</font> <font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">bool</font> <font color="#000000">found</font> <font color="#434f54">=</font> <b><font color="#d35400">SD</font></b><font color="#434f54">.</font><font color="#d35400">exists</font><font color="#000000">(</font><font color="#000000">uri</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font> <font color="#000000">(</font><font color="#000000">found</font> <font color="#434f54">&amp;&amp;</font> <font color="#000000">client</font><font color="#434f54">.</font><font color="#d35400">connected</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">)</font> <font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">client</font><font color="#434f54">.</font><font color="#d35400">println</font><font color="#000000">(</font><font color="#000000">F</font><font color="#000000">(</font><font color="#005c5f">&#34;HTTP&#47;1.1 200 OK&#34;</font><font color="#000000">)</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">client</font><font color="#434f54">.</font><font color="#d35400">print</font> &nbsp;<font color="#000000">(</font><font color="#000000">F</font><font color="#000000">(</font><font color="#005c5f">&#34;Content-Type: &#34;</font><font color="#000000">)</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">client</font><font color="#434f54">.</font><font color="#d35400">println</font><font color="#000000">(</font><font color="#000000">parseContentType</font><font color="#000000">(</font><font color="#000000">uri</font><font color="#000000">)</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">client</font><font color="#434f54">.</font><font color="#d35400">println</font><font color="#000000">(</font><font color="#000000">F</font><font color="#000000">(</font><font color="#005c5f">&#34;Connection: close&#34;</font><font color="#000000">)</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">client</font><font color="#434f54">.</font><font color="#d35400">println</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font> <font color="#5e6d03">else</font> <font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">client</font><font color="#434f54">.</font><font color="#d35400">print</font><font color="#000000">(</font><font color="#000000">F</font><font color="#000000">(</font><font color="#005c5f">&#34;HTTP&#47;1.1 404 Not Found\n&#34;</font><font color="#000000">)</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
<font color="#000000">}</font>

<font color="#00979c">void</font> 
<font color="#000000">processGetRequest</font><font color="#000000">(</font><b><font color="#d35400">EthernetClient</font></b> <font color="#000000">client</font><font color="#434f54">,</font> <font color="#00979c">char</font><font color="#434f54">*</font> <font color="#000000">uri</font><font color="#000000">)</font> <font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">processHeadRequest</font><font color="#000000">(</font><font color="#000000">client</font><font color="#434f54">,</font> <font color="#000000">uri</font><font color="#000000">)</font><font color="#000000">;</font> <font color="#434f54">&#47;&#47;Create the HEAD response</font>
 &nbsp;&nbsp;&nbsp;<b><font color="#d35400">File</font></b> <font color="#000000">file</font> <font color="#434f54">=</font> <b><font color="#d35400">SD</font></b><font color="#434f54">.</font><font color="#d35400">open</font><font color="#000000">(</font><font color="#000000">uri</font><font color="#000000">)</font><font color="#000000">;</font> <font color="#434f54">&#47;&#47;Print the contents</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font> <font color="#000000">(</font><font color="#000000">file</font><font color="#434f54">.</font><font color="#000000">isDirectory</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">)</font> <font color="#000000">{</font>

 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font> <font color="#5e6d03">else</font> <font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">while</font><font color="#000000">(</font><font color="#000000">file</font><font color="#434f54">.</font><font color="#d35400">available</font><font color="#000000">(</font><font color="#000000">)</font> <font color="#434f54">&amp;&amp;</font> <font color="#000000">client</font><font color="#434f54">.</font><font color="#d35400">connected</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">)</font> <font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">char</font> <font color="#000000">c</font> <font color="#434f54">=</font> <font color="#000000">file</font><font color="#434f54">.</font><font color="#d35400">read</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">client</font><font color="#434f54">.</font><font color="#d35400">write</font><font color="#000000">(</font><font color="#000000">c</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font><font color="#000000">(</font><font color="#000000">DEBUGGING</font><font color="#000000">)</font><font color="#000000">{</font> 
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font> <font color="#000000">(</font><font color="#000000">c</font><font color="#434f54">==</font><font color="#00979c">&#39;\n&#39;</font><font color="#000000">)</font> <font color="#000000">{</font><b><font color="#d35400">Serial</font></b><font color="#434f54">.</font><font color="#d35400">println</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font><font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">else</font> <font color="#000000">{</font> <b><font color="#d35400">Serial</font></b><font color="#434f54">.</font><font color="#d35400">write</font><font color="#000000">(</font><font color="#000000">c</font><font color="#000000">)</font><font color="#000000">;</font> <font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font><font color="#434f54">&#47;&#47;end while(file.available())</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font><font color="#434f54">&#47;&#47;end else of if(file.isDirectory()) </font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">file</font><font color="#434f54">.</font><font color="#d35400">close</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font>
<font color="#000000">}</font>

<font color="#00979c">void</font> 
<font color="#000000">processPutRequest</font><font color="#000000">(</font><b><font color="#d35400">EthernetClient</font></b> <font color="#000000">client</font><font color="#434f54">,</font> <font color="#00979c">char</font><font color="#434f54">*</font> <font color="#000000">uri</font><font color="#000000">)</font> <font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; See if the proper authorization had been provided during the request parsing</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font> <font color="#000000">(</font><font color="#434f54">!</font><font color="#000000">Authorized</font><font color="#000000">)</font><font color="#000000">{</font> 
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">client</font><font color="#434f54">.</font><font color="#d35400">println</font><font color="#000000">(</font><font color="#000000">F</font><font color="#000000">(</font><font color="#005c5f">&#34;HTTP&#47;1.1 401 Unauthorized\n&#34;</font><font color="#000000">)</font><font color="#000000">)</font><font color="#000000">;</font> 
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">return</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font> <font color="#000000">(</font><b><font color="#d35400">SD</font></b><font color="#434f54">.</font><font color="#d35400">exists</font><font color="#000000">(</font><font color="#000000">uri</font><font color="#000000">)</font><font color="#000000">)</font><font color="#000000">{</font> <font color="#434f54">&#47;&#47; Check if the requested URI already exists</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b><font color="#d35400">File</font></b> <font color="#000000">file</font> <font color="#434f54">=</font> <b><font color="#d35400">SD</font></b><font color="#434f54">.</font><font color="#d35400">open</font><font color="#000000">(</font><font color="#000000">uri</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font> <font color="#000000">(</font><font color="#000000">file</font><font color="#434f54">.</font><font color="#000000">isDirectory</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">)</font><font color="#000000">{</font> <font color="#434f54">&#47;&#47; If it is a directory, don&#39;t allow the PUT request (i.e. no writing directories)</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">file</font><font color="#434f54">.</font><font color="#d35400">close</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">client</font><font color="#434f54">.</font><font color="#d35400">println</font><font color="#000000">(</font><font color="#000000">F</font><font color="#000000">(</font><font color="#005c5f">&#34;HTTP&#47;1.1 405 Method Not Allowed\n&#34;</font><font color="#000000">)</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">return</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font> <font color="#5e6d03">else</font> <font color="#000000">{</font> <font color="#434f54">&#47;&#47; If it is a file, delete the existing version</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">file</font><font color="#434f54">.</font><font color="#d35400">close</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b><font color="#d35400">SD</font></b><font color="#434f54">.</font><font color="#d35400">remove</font><font color="#000000">(</font><font color="#000000">uri</font><font color="#000000">)</font><font color="#000000">;</font> 
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b><font color="#d35400">SD</font></b><font color="#434f54">.</font><font color="#d35400">rmdir</font><font color="#000000">(</font><font color="#000000">uri</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font> <font color="#5e6d03">else</font> <font color="#000000">{</font> <font color="#434f54">&#47;&#47;Create intermediate directories if they don&#39;t exist, otherwise SD.open() will fail to create the file</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">short</font> <font color="#000000">lastSlash</font><font color="#434f54">=</font><font color="#000000">UriLen</font><font color="#434f54">-</font><font color="#000000">1</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">while</font> <font color="#000000">(</font><font color="#000000">lastSlash</font><font color="#434f54">&gt;</font><font color="#000000">0</font> <font color="#434f54">&amp;&amp;</font> <font color="#000000">uri</font><font color="#000000">[</font><font color="#000000">lastSlash</font><font color="#000000">]</font><font color="#434f54">!=</font><font color="#00979c">&#39;&#47;&#39;</font><font color="#000000">)</font><font color="#000000">{</font> <font color="#000000">lastSlash</font><font color="#434f54">--</font><font color="#000000">;</font> <font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">char</font> <font color="#000000">dir</font><font color="#000000">[</font><font color="#000000">lastSlash</font><font color="#434f54">+</font><font color="#000000">1</font><font color="#000000">]</font> <font color="#434f54">=</font> <font color="#005c5f">&#34;&#34;</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">for</font> <font color="#000000">(</font><font color="#00979c">short</font> <font color="#000000">i</font><font color="#434f54">=</font><font color="#000000">0</font><font color="#000000">;</font> <font color="#000000">i</font><font color="#434f54">&lt;</font><font color="#000000">lastSlash</font><font color="#000000">;</font> <font color="#000000">i</font><font color="#434f54">++</font><font color="#000000">)</font> <font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">dir</font><font color="#000000">[</font><font color="#000000">i</font><font color="#000000">]</font> <font color="#434f54">=</font> <font color="#000000">uri</font><font color="#000000">[</font><font color="#000000">i</font><font color="#000000">]</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font> <font color="#000000">(</font><font color="#434f54">!</font><b><font color="#d35400">SD</font></b><font color="#434f54">.</font><font color="#d35400">exists</font><font color="#000000">(</font><font color="#000000">dir</font><font color="#000000">)</font><font color="#000000">)</font><font color="#000000">{</font> <b><font color="#d35400">SD</font></b><font color="#434f54">.</font><font color="#d35400">mkdir</font><font color="#000000">(</font><font color="#000000">dir</font><font color="#000000">)</font><font color="#000000">;</font> <font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font><font color="#434f54">&#47;&#47;end else of if(SD.exists(uri))</font>

 &nbsp;&nbsp;&nbsp;<font color="#000000">client</font><font color="#434f54">.</font><font color="#d35400">println</font><font color="#000000">(</font><font color="#000000">F</font><font color="#000000">(</font><font color="#005c5f">&#34;HTTP&#47;1.1 100 Continue\n&#34;</font><font color="#000000">)</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">long</font> <font color="#000000">t</font> <font color="#434f54">=</font> <font color="#d35400">millis</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font> <font color="#434f54">&#47;&#47; Record current time to check for timeout</font>
 &nbsp;&nbsp;&nbsp;<b><font color="#d35400">File</font></b> <font color="#000000">file</font> <font color="#434f54">=</font> <b><font color="#d35400">SD</font></b><font color="#434f54">.</font><font color="#d35400">open</font><font color="#000000">(</font><font color="#000000">uri</font><font color="#434f54">,</font> <font color="#00979c">FILE_WRITE</font><font color="#000000">)</font><font color="#000000">;</font> <font color="#434f54">&#47;&#47; Prepare the the file to be written</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">while</font> <font color="#000000">(</font><font color="#434f54">!</font><font color="#000000">client</font><font color="#434f54">.</font><font color="#d35400">available</font><font color="#000000">(</font><font color="#000000">)</font> <font color="#434f54">&amp;&amp;</font> <font color="#d35400">millis</font><font color="#000000">(</font><font color="#000000">)</font><font color="#434f54">-</font><font color="#000000">t</font><font color="#434f54">&lt;</font><font color="#000000">5000</font><font color="#000000">)</font> <font color="#000000">{</font> <font color="#d35400">delay</font><font color="#000000">(</font><font color="#000000">1</font><font color="#000000">)</font><font color="#000000">;</font> <font color="#000000">}</font> <font color="#434f54">&#47;&#47; Wait for the content to be sent, timing out after 5 seconds</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font> <font color="#000000">(</font><font color="#000000">DEBUGGING</font><font color="#000000">)</font> <font color="#000000">{</font> <b><font color="#d35400">Serial</font></b><font color="#434f54">.</font><font color="#d35400">println</font><font color="#000000">(</font><font color="#000000">F</font><font color="#000000">(</font><font color="#005c5f">&#34; -Begin Body- &#34;</font><font color="#000000">)</font><font color="#000000">)</font><font color="#000000">;</font> <font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">char</font> <font color="#000000">c</font> <font color="#434f54">=</font> <font color="#000000">0</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">while</font> <font color="#000000">(</font><font color="#000000">client</font><font color="#434f54">.</font><font color="#d35400">available</font><font color="#000000">(</font><font color="#000000">)</font> <font color="#434f54">&amp;&amp;</font> <font color="#000000">c</font><font color="#434f54">!=</font><font color="#000000">EOF</font><font color="#000000">)</font> <font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">c</font> <font color="#434f54">=</font> <font color="#000000">client</font><font color="#434f54">.</font><font color="#d35400">read</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">file</font><font color="#434f54">.</font><font color="#d35400">write</font><font color="#000000">(</font><font color="#000000">c</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font> <font color="#000000">(</font><font color="#000000">DEBUGGING</font><font color="#000000">)</font> <font color="#000000">{</font> 
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font> <font color="#000000">(</font><font color="#000000">c</font><font color="#434f54">==</font><font color="#00979c">&#39;\n&#39;</font><font color="#000000">)</font> <font color="#000000">{</font> <b><font color="#d35400">Serial</font></b><font color="#434f54">.</font><font color="#d35400">println</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font> <font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">else</font> <font color="#000000">{</font> <b><font color="#d35400">Serial</font></b><font color="#434f54">.</font><font color="#d35400">write</font><font color="#000000">(</font><font color="#000000">c</font><font color="#000000">)</font><font color="#000000">;</font> <font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">file</font><font color="#434f54">.</font><font color="#d35400">close</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">client</font><font color="#434f54">.</font><font color="#d35400">println</font><font color="#000000">(</font><font color="#000000">F</font><font color="#000000">(</font><font color="#005c5f">&#34;HTTP&#47;1.1 200 OK\n&#34;</font><font color="#000000">)</font><font color="#000000">)</font><font color="#000000">;</font>
<font color="#000000">}</font>

<font color="#00979c">void</font>
<font color="#000000">processPostRequest</font><font color="#000000">(</font><b><font color="#d35400">EthernetClient</font></b> <font color="#000000">client</font><font color="#434f54">,</font> <font color="#00979c">char</font><font color="#434f54">*</font> <font color="#000000">uri</font><font color="#000000">)</font> <font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font> <font color="#000000">(</font><b><font color="#d35400">SD</font></b><font color="#434f54">.</font><font color="#d35400">exists</font><font color="#000000">(</font><font color="#000000">uri</font><font color="#000000">)</font><font color="#000000">)</font><font color="#000000">{</font> <font color="#434f54">&#47;&#47; Check if the requested URI already exists</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b><font color="#d35400">File</font></b> <font color="#000000">file</font> <font color="#434f54">=</font> <b><font color="#d35400">SD</font></b><font color="#434f54">.</font><font color="#d35400">open</font><font color="#000000">(</font><font color="#000000">uri</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font> <font color="#000000">(</font><font color="#000000">file</font><font color="#434f54">.</font><font color="#000000">isDirectory</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">)</font><font color="#000000">{</font> <font color="#434f54">&#47;&#47; If it is a directory, don&#39;t allow the POST request (i.e. no writing directories)</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">file</font><font color="#434f54">.</font><font color="#d35400">close</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">client</font><font color="#434f54">.</font><font color="#d35400">println</font><font color="#000000">(</font><font color="#000000">F</font><font color="#000000">(</font><font color="#005c5f">&#34;HTTP&#47;1.1 405 Method Not Allowed\n&#34;</font><font color="#000000">)</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">return</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font> <font color="#5e6d03">else</font> <font color="#000000">{</font> <font color="#434f54">&#47;&#47; If it is a file, delete the existing version</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">file</font><font color="#434f54">.</font><font color="#d35400">close</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font> <font color="#5e6d03">else</font> <font color="#000000">{</font> <font color="#434f54">&#47;&#47;Create intermediate directories if they don&#39;t exist, otherwise SD.open() will fail to create the file</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">short</font> <font color="#000000">lastSlash</font><font color="#434f54">=</font><font color="#000000">UriLen</font><font color="#434f54">-</font><font color="#000000">1</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">while</font> <font color="#000000">(</font><font color="#000000">lastSlash</font><font color="#434f54">&gt;</font><font color="#000000">0</font> <font color="#434f54">&amp;&amp;</font> <font color="#000000">uri</font><font color="#000000">[</font><font color="#000000">lastSlash</font><font color="#000000">]</font><font color="#434f54">!=</font><font color="#00979c">&#39;&#47;&#39;</font><font color="#000000">)</font><font color="#000000">{</font> <font color="#000000">lastSlash</font><font color="#434f54">--</font><font color="#000000">;</font> <font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">char</font> <font color="#000000">dir</font><font color="#000000">[</font><font color="#000000">lastSlash</font><font color="#434f54">+</font><font color="#000000">1</font><font color="#000000">]</font> <font color="#434f54">=</font> <font color="#005c5f">&#34;&#34;</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">for</font> <font color="#000000">(</font><font color="#00979c">short</font> <font color="#000000">i</font><font color="#434f54">=</font><font color="#000000">0</font><font color="#000000">;</font> <font color="#000000">i</font><font color="#434f54">&lt;</font><font color="#000000">lastSlash</font><font color="#000000">;</font> <font color="#000000">i</font><font color="#434f54">++</font><font color="#000000">)</font> <font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">dir</font><font color="#000000">[</font><font color="#000000">i</font><font color="#000000">]</font> <font color="#434f54">=</font> <font color="#000000">uri</font><font color="#000000">[</font><font color="#000000">i</font><font color="#000000">]</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font> <font color="#000000">(</font><font color="#434f54">!</font><b><font color="#d35400">SD</font></b><font color="#434f54">.</font><font color="#d35400">exists</font><font color="#000000">(</font><font color="#000000">dir</font><font color="#000000">)</font><font color="#000000">)</font><font color="#000000">{</font> <b><font color="#d35400">SD</font></b><font color="#434f54">.</font><font color="#d35400">mkdir</font><font color="#000000">(</font><font color="#000000">dir</font><font color="#000000">)</font><font color="#000000">;</font> <font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font><font color="#434f54">&#47;&#47;end else of if(SD.exists(uri))</font>

 &nbsp;&nbsp;&nbsp;<font color="#000000">client</font><font color="#434f54">.</font><font color="#d35400">println</font><font color="#000000">(</font><font color="#000000">F</font><font color="#000000">(</font><font color="#005c5f">&#34;HTTP&#47;1.1 100 Continue\n&#34;</font><font color="#000000">)</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">long</font> <font color="#000000">t</font> <font color="#434f54">=</font> <font color="#d35400">millis</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font> <font color="#434f54">&#47;&#47; Record current time to check for timeout</font>
 &nbsp;&nbsp;&nbsp;<b><font color="#d35400">File</font></b> <font color="#000000">file</font> <font color="#434f54">=</font> <b><font color="#d35400">SD</font></b><font color="#434f54">.</font><font color="#d35400">open</font><font color="#000000">(</font><font color="#000000">uri</font><font color="#434f54">,</font> <font color="#00979c">FILE_WRITE</font><font color="#000000">)</font><font color="#000000">;</font> <font color="#434f54">&#47;&#47; Prepare the the file to be written</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">while</font> <font color="#000000">(</font><font color="#434f54">!</font><font color="#000000">client</font><font color="#434f54">.</font><font color="#d35400">available</font><font color="#000000">(</font><font color="#000000">)</font> <font color="#434f54">&amp;&amp;</font> <font color="#d35400">millis</font><font color="#000000">(</font><font color="#000000">)</font><font color="#434f54">-</font><font color="#000000">t</font><font color="#434f54">&lt;</font><font color="#000000">5000</font><font color="#000000">)</font> <font color="#000000">{</font> <font color="#d35400">delay</font><font color="#000000">(</font><font color="#000000">1</font><font color="#000000">)</font><font color="#000000">;</font> <font color="#000000">}</font> <font color="#434f54">&#47;&#47; Wait for the content to be sent, timing out after 5 seconds</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font> <font color="#000000">(</font><font color="#000000">DEBUGGING</font><font color="#434f54">||</font><font color="#000000">DISPLAYING</font><font color="#000000">)</font> <font color="#000000">{</font> <b><font color="#d35400">Serial</font></b><font color="#434f54">.</font><font color="#d35400">println</font><font color="#000000">(</font><font color="#000000">F</font><font color="#000000">(</font><font color="#005c5f">&#34; -Begin Body- &#34;</font><font color="#000000">)</font><font color="#000000">)</font><font color="#000000">;</font> <font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">char</font> <font color="#000000">c</font> <font color="#434f54">=</font> <font color="#000000">0</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">while</font> <font color="#000000">(</font><font color="#000000">client</font><font color="#434f54">.</font><font color="#d35400">available</font><font color="#000000">(</font><font color="#000000">)</font> <font color="#434f54">&amp;&amp;</font> <font color="#000000">c</font><font color="#434f54">!=</font><font color="#000000">EOF</font><font color="#000000">)</font> <font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">c</font> <font color="#434f54">=</font> <font color="#000000">client</font><font color="#434f54">.</font><font color="#d35400">read</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">file</font><font color="#434f54">.</font><font color="#d35400">write</font><font color="#000000">(</font><font color="#000000">c</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font> <font color="#000000">(</font><font color="#000000">DEBUGGING</font><font color="#434f54">||</font><font color="#000000">DISPLAYING</font><font color="#000000">)</font> <font color="#000000">{</font> 
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font> <font color="#000000">(</font><font color="#000000">c</font><font color="#434f54">==</font><font color="#00979c">&#39;\n&#39;</font><font color="#000000">)</font> <font color="#000000">{</font> <b><font color="#d35400">Serial</font></b><font color="#434f54">.</font><font color="#d35400">println</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font> <font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">else</font> <font color="#000000">{</font> <b><font color="#d35400">Serial</font></b><font color="#434f54">.</font><font color="#d35400">write</font><font color="#000000">(</font><font color="#000000">c</font><font color="#000000">)</font><font color="#000000">;</font> <font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">file</font><font color="#434f54">.</font><font color="#d35400">close</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">client</font><font color="#434f54">.</font><font color="#d35400">println</font><font color="#000000">(</font><font color="#000000">F</font><font color="#000000">(</font><font color="#005c5f">&#34;HTTP&#47;1.1 200 OK\n&#34;</font><font color="#000000">)</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font> <font color="#000000">(</font><font color="#000000">DEBUGGING</font><font color="#434f54">||</font><font color="#000000">DISPLAYING</font><font color="#000000">)</font> <font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b><font color="#d35400">Serial</font></b><font color="#434f54">.</font><font color="#d35400">println</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
<font color="#000000">}</font>
<font color="#95a5a6">&#47;* Finish request handler functions *&#47;</font>

<font color="#434f54">&#47;&#47;Determines filetype from the file extension</font>
<font color="#00979c">String</font> 
<font color="#000000">parseContentType</font><font color="#000000">(</font><font color="#00979c">char</font><font color="#434f54">*</font> <font color="#000000">uri</font><font color="#000000">)</font> <font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">short</font> <font color="#000000">i</font> <font color="#434f54">=</font> <font color="#000000">UriLen</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">short</font> <font color="#000000">e</font> <font color="#434f54">=</font> <font color="#000000">0</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">char</font> <font color="#000000">ext</font><font color="#000000">[</font><font color="#000000">4</font><font color="#000000">]</font> <font color="#434f54">=</font> <font color="#000000">{</font><font color="#000000">0</font><font color="#434f54">,</font><font color="#000000">0</font><font color="#434f54">,</font><font color="#000000">0</font><font color="#434f54">,</font><font color="#000000">0</font><font color="#000000">}</font><font color="#000000">;</font> <font color="#434f54">&#47;&#47;Create an empty string</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">while</font> <font color="#000000">(</font><font color="#000000">uri</font><font color="#000000">[</font><font color="#434f54">--</font><font color="#000000">i</font><font color="#000000">]</font><font color="#434f54">!=</font><font color="#00979c">&#39;.&#39;</font> <font color="#434f54">&amp;&amp;</font> <font color="#000000">i</font><font color="#434f54">&gt;</font><font color="#000000">0</font><font color="#000000">)</font> <font color="#000000">{</font> <font color="#000000">;</font><font color="#000000">;</font> <font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">while</font> <font color="#000000">(</font><font color="#000000">uri</font><font color="#000000">[</font><font color="#000000">i</font><font color="#000000">]</font><font color="#434f54">!=</font><font color="#000000">0</font><font color="#000000">)</font> <font color="#000000">{</font> <font color="#000000">ext</font><font color="#000000">[</font><font color="#000000">e</font><font color="#434f54">++</font><font color="#000000">]</font> <font color="#434f54">=</font> <font color="#000000">uri</font><font color="#000000">[</font><font color="#434f54">++</font><font color="#000000">i</font><font color="#000000">]</font><font color="#000000">;</font> <font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; Return the appropriate content-type</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font><font color="#000000">(</font><font color="#d35400">strcmp</font><font color="#000000">(</font><font color="#000000">ext</font><font color="#434f54">,</font><font color="#005c5f">&#34;htm&#34;</font><font color="#000000">)</font><font color="#434f54">==</font><font color="#000000">0</font><font color="#000000">)</font><font color="#000000">{</font> <font color="#5e6d03">return</font> <font color="#005c5f">&#34;text&#47;html&#34;</font><font color="#000000">;</font> <font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">else</font> <font color="#5e6d03">if</font><font color="#000000">(</font><font color="#d35400">strcmp</font><font color="#000000">(</font><font color="#000000">ext</font><font color="#434f54">,</font><font color="#005c5f">&#34;css&#34;</font><font color="#000000">)</font><font color="#434f54">==</font><font color="#000000">0</font><font color="#000000">)</font><font color="#000000">{</font> <font color="#5e6d03">return</font> <font color="#005c5f">&#34;text&#47;css&#34;</font><font color="#000000">;</font> <font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">else</font> <font color="#5e6d03">if</font><font color="#000000">(</font><font color="#d35400">strcmp</font><font color="#000000">(</font><font color="#000000">ext</font><font color="#434f54">,</font><font color="#005c5f">&#34;js&#34;</font><font color="#000000">)</font><font color="#434f54">==</font><font color="#000000">0</font><font color="#000000">)</font> <font color="#000000">{</font> <font color="#5e6d03">return</font> <font color="#005c5f">&#34;text&#47;javascript&#34;</font><font color="#000000">;</font> <font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">else</font> <font color="#5e6d03">if</font><font color="#000000">(</font><font color="#d35400">strcmp</font><font color="#000000">(</font><font color="#000000">ext</font><font color="#434f54">,</font><font color="#005c5f">&#34;jpg&#34;</font><font color="#000000">)</font><font color="#434f54">==</font><font color="#000000">0</font><font color="#000000">)</font><font color="#000000">{</font> <font color="#5e6d03">return</font> <font color="#005c5f">&#34;image&#47;jpeg&#34;</font><font color="#000000">;</font> <font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">else</font> <font color="#5e6d03">if</font><font color="#000000">(</font><font color="#d35400">strcmp</font><font color="#000000">(</font><font color="#000000">ext</font><font color="#434f54">,</font><font color="#005c5f">&#34;svg&#34;</font><font color="#000000">)</font><font color="#434f54">==</font><font color="#000000">0</font><font color="#000000">)</font><font color="#000000">{</font> <font color="#5e6d03">return</font> <font color="#005c5f">&#34;image&#47;svg+xml&#34;</font><font color="#000000">;</font> <font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">else</font> <font color="#000000">{</font> <font color="#5e6d03">return</font> <font color="#005c5f">&#34;*&#47;*&#34;</font><font color="#000000">;</font> <font color="#000000">}</font>
<font color="#000000">}</font>

</pre>
    </body>
</html>
